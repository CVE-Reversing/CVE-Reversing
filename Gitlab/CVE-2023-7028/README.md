# CVE-2023-7028

Let's first review the payload used in the POC to takeover the user account.

![image](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/bbbf1b39-7b88-40df-8812-090178eeecdb)

If you look at the above screenshot the request `Content-Type` is `application/x-www-form-urlencoded` and the `user` parameter in the request is an object with key email now the attacker added one more `[]` to change the type of email key from string to a list. In simple words attacker did this:

```json
// Originaly expecpted
{"user":{"email":"user@email.com"}}
```
```json
// Attacker injected
{"user":{"email":["user@email.com","hacker@email.com"]}}
```
So how does this leads to account takeover? why attacker is able to get password reset token of user?

Let's jump into the code and find out the root cause:

The password reset request is getting handled by the following ActionController which is calling a method `create`
![1](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/24de744d-15f9-422f-b25c-63cd2a5a5668)

Then in `create` function it is calling a function `send_reset_password_instructions` with request body as a parameter, If you look at the debug console you can see it contains supplied emails as a list.

![2](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/1916e2b4-0dfe-4463-aa7f-9fd8926c228b)

in `send_reset_password_instructions` at line `10` it is running `attributes.delete` function to delete the `email` key in the object and only return the value which is expected to be the string but in this case it is a list `[<victim-email>, <hacker-email>]`.
![3](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/6f2e0934-0ca0-41e3-8a55-96a4fcf58a07)
On line 13 it is passing list of emails to function `by_email_with_errors`
![4](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/4e6e5204-be85-4d30-980c-e5c25e1c7dfd)

it is again passing the email to another function called `find_by_any_email` whith a default parameter value `confirmed` set to `true` 
![5](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/361e4447-1acb-46c1-b41c-1264d6ac3cdb)

Again it is passing the email to another function called `by_any_email` and listening for the return value
![6](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/60c1f9d7-decf-4c74-ad10-99758a256ce9)
Again it is passing emails to by_user_email function
![7](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/305aae8e-6cf2-4772-a23c-1fca474230cf)

![8](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/7ac267d9-b31c-4bfd-a6e3-5f57fceb7730)
![9](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/c22d6cfc-a089-474b-b4bd-6ebe1476e3fb)
![10](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/f6ce38c0-46da-4175-80eb-6d911dbf83e3)
![11](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/357bf743-df41-44e5-b2f6-fbd577d1ff5c)
![12](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/0436d83c-aea8-4234-abac-f69da477fb79)
![13](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/e082cd6d-a6a6-4c20-98de-f5126dfd62a2)
![14](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/6e6524c6-b3dc-498c-a905-d9f76fa14858)
![15](https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/9059fefd-9796-4a43-93e0-fd4917595e4c)
